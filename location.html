<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Request</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Base styles */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
            overflow: hidden; 
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #map {
            flex: 1; 
            height: 100%;
            background-color: #e0e0e0; 
        }

        .sidebar {
            width: 400px; 
            background-color: #0f2336; /* Dark blue background */
            color: white;
            padding: 25px 20px; /* Increased top/bottom padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2); /* Soft shadow for depth */
        }

        .section {
            margin-bottom: 25px;
        }

        /* --- Header Alignment --- */
        .sidebar-header-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px; /* Space before campus buttons */
        }
        
        .sidebar-header-row .section {
            margin-bottom: 0; /* Remove section margin when in header row */
            flex-grow: 1;
        }
        
        .sidebar-header-row .section h3 {
            padding-bottom: 0;
            border-bottom: none;
            margin-bottom: 0;
        }
        /* --- END Header Alignment --- */


        .section h3 {
            text-align: left; /* iOS headings often align left */
            margin-top: 0;
            font-size: 1.4em; /* Slightly larger heading */
            font-weight: 600; /* Semi-bold */
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* --- Description Box Styling --- */
        .description-box h3 {
             margin-bottom: 15px; 
        }

        #rideDescription {
            width: 100%;
            min-height: 80px; 
            max-height: 120px; 
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px; 
            background-color: rgba(255, 255, 255, 0.08); 
            color: white;
            font-size: 1em;
            resize: vertical; 
            font-family: inherit; 
        }

        #rideDescription::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-weight: 300;
        }


        /* --- Request Button Styling (Primary Action) --- */
        .request-section {
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .make-request-btn {
            width: 100%;
            padding: 18px; /* Large tap area */
            background-color: #26c166; 
            background-image: linear-gradient(to top, #26c166, #36d476); 
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px; 
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(38, 193, 102, 0.4); 
        }

        .make-request-btn:hover {
            background-color: #1e9d56;
            background-image: linear-gradient(to top, #1e9d56, #2acb66);
            box-shadow: 0 2px 8px rgba(38, 193, 102, 0.6);
        }
        
        /* --- Back Button ICON Styling (Modified) --- */
        .back-button-container {
            margin-bottom: 0; 
            text-align: left;
        }

        .back-button {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1); 
            border: none;
            color: white;
            font-size: 1.2em; 
            padding: 6px 12px; 
            border-radius: 50%;
            cursor: pointer;
            text-decoration: none;
            line-height: 1;
            transition: background-color 0.2s, color 0.2s;
            margin-right: 15px; 
            flex-shrink: 0;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #15c8ff;
        }

        /* --- Other Modal/Notification styles remain unchanged --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: rgba(44, 74, 105, 0.95); 
            padding: 40px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #15c8ff; 
            border-radius: 50%;
            width: 50px; 
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content h3 {
             font-size: 1.3em;
             margin-bottom: 10px;
        }

        .modal-content p {
            font-size: 1.1em;
            font-weight: 500;
        }

        .cancel-btn-style { 
            padding: 12px 25px;
            background-color: #dc3545; 
            background-image: linear-gradient(to top, #dc3545, #e05e69);
            color: white; 
            font-weight: 600;
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.4);
            margin-top: 25px;
        }

        .cancel-btn-style:hover {
            background-color: #c82333;
        }
        
        #riderFoundNotification {
            position: absolute;
            bottom: 20px;
            left: 50%; 
            transform: translate(-50%, 120px); 
            width: 90%;
            max-width: 360px;
            background-color: #26c166; 
            background-image: linear-gradient(to right, #26c166, #36d476);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 6px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27), opacity 0.5s ease-out; 
            z-index: 999;
        }
        
        #riderFoundNotification.visible {
            transform: translate(-50%, 0); 
            opacity: 1;
        }

        #customAlert {
            display: none;
            position: fixed;
            top: 10%; 
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #dc3545; 
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 4px 15px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            text-align: center;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        /* --- Fare Display --- */
        .fare-display {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }
        .fare-display h3 {
            font-size: 1.1em;
            margin: 0;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }
        .fare-display p {
            font-size: 2em;
            font-weight: bold;
            color: #15c8ff;
            margin: 5px 0 0;
        }
        
        /* --- Campus Buttons --- */
        .ios-campus-btn {
            background: rgba(255,255,255,0.08);
            color: #fff; /* Keep text white on dark background */
            border: none;
            border-radius: 14px;
            padding: 10px 18px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin: 0;
            cursor: pointer;
            transition: background .14s, transform .08s, box-shadow .14s;
        }
        .ios-campus-btn:hover {
            background: rgba(22,113,183,0.12);
            color: #fff; /* Keep text white */
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 18px rgba(22,113,183,0.18);
        }
        
        /* --- Mobile Responsiveness Adjustments (CRITICAL FIXES) --- */
        @media (max-width: 768px) {
            /* FIX: Ensure body allows 100% viewport and prevents scrolling */
            body {
                overflow-y: hidden; 
                height: 100vh;
            }
            .container {
                flex-direction: column; 
                height: 100%; 
            }

            /* 1. Map takes 40% of the screen */
            #map {
                height: 40vh; 
                flex: none; 
            }

            /* 2. Sidebar takes the remaining 60% and is NOT scrollable */
            .sidebar {
                width: 100%; 
                height: 60vh; 
                padding: 15px; 
                box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2); 
                overflow-y: hidden; 
                flex: none;
                justify-content: flex-start; 
            }

            /* 3. Significantly reduce vertical spacing and compact elements */
            
            .sidebar-header-row {
                margin-bottom: 8px; 
            }

            /* **Tighter fit for sections** */
            .section {
                margin-bottom: 4px; /* Reduced from 8px to 4px */
            }

            .section h3 {
                padding-bottom: 5px; 
                margin-bottom: 5px; 
                font-size: 1.2em; 
            }
            
            .pick-up-location-buttons {
                margin-bottom: 4px !important; /* Reduced margin below buttons */
            }

            .ios-campus-btn {
                padding: 8px 10px; 
                font-size: 13px;
            }
            
            #rideDescription {
                min-height: 40px; 
                max-height: 60px; 
                padding: 8px; 
            }
            
            .fare-display {
                margin-top: 5px; 
                padding: 4px; /* Reduced padding */
            }
            
            .fare-display p {
                font-size: 1.8em; 
            }

            /* **CRITICAL: Bring Make Request button closer** */
            .request-section {
                padding-top: 5px; /* Reduced from 10px to 5px */
                margin-top: auto; 
            }
            
            .make-request-btn {
                padding: 12px; 
                font-size: 1em;
            }
        }

    </style>
        <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
</head>
<body>
    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar">
            
            <div class="sidebar-header-row">
                <div class="back-button-container">
                    <a href="options.html" class="back-button" aria-label="Back to Options">←</a>
                </div>
                <div class="section pick-up-location" style="margin-bottom: 0;"> 
                    <h3>Pick-up Location</h3>
                </div>
            </div>
            
            <div>
                <div class="pick-up-location-buttons" style="display:flex; gap:12px; justify-content:center; margin-bottom:10px;">
                    <button class="ios-campus-btn" onclick="showRouteToCampus('main'); return false;">Gordon College Main Campus</button>
                    <button class="ios-campus-btn" onclick="showRouteToCampus('annex'); return false;">Gordon College Annex Campus</button>
                </div>

                <div class="section description-box">
                    <h3>Description (Optional)</h3>
                    <textarea id="rideDescription" placeholder="e.g., I have a black bag and long hair" rows="3"></textarea>
                </div>
                
                <div class="section fare-display">
                    <h3>Estimated Fare</h3>
                    <p id="estimatedFare">₱0.00</p>
                </div>

            </div>

                <div class="request-section" style="margin-top: 8px; padding-top: 0;">
                    <button class="make-request-btn" onclick="handleMakeRequest()">Make Request</button>
                </div>
        </div>
    </div>

    <div id="waitingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="loader"></div>
            <h3>Requesting Ride...</h3>
            <p id="waitingMessage">Waiting for Rider...</p>
            <button onclick="cancelRequest()" class="cancel-btn-style">
                Cancel Request
            </button>
        </div>
    </div>
    
    <div id="customAlert"></div>

    <div id="riderFoundNotification">
        <p style="font-size: 1.1em; margin: 0; font-weight: bold;">Rider is on its way!</p>
        <p style="font-size: 0.9em; margin: 5px 0 0;">Check your status on the map.</p>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        // Leaflet Map Initialization (kept simple)
        var map = L.map('map').setView([14.8314775, 120.2819695], 16); 

            // Routing control instance
            var routingControl = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

       

        // Coordinates for common locations (must match locations used in all files)
        const locations = {
            'main': { name: 'Gordon College Main Campus', coords: [14.8324, 120.2833] },
            'annex': { name: 'Gordon College ANNEX Campus', coords: [14.8372648, 120.2798648] }
        };

            // Store user's pinned location
            window._userPinnedLocation = null;
            window._userPinnedMarker = null; // Marker for the pinned location
        
        // Global state for request timeout and selected location
        window._requestTimeout = null;
        window._pickupMarker = null; 
        window._selectedLocationKey = null; // The selected campus destination

        // Function to calculate fare (Minimum 50.00 Pesos)
        function calculateFare(distanceInMeters) {
            // Placeholder: Assume a base fare + a simple rate per kilometer
            const BASE_FARE = 50.00;
            const RATE_PER_KM = 10.00;
            
            if (distanceInMeters === 0 || isNaN(distanceInMeters)) return BASE_FARE.toFixed(2);
            
            const distanceInKm = distanceInMeters / 1000;
            const fare = BASE_FARE + (distanceInKm * RATE_PER_KM);
            return fare.toFixed(2);
        }
        
        function updateFareDisplay(distanceInMeters) {
            const fare = calculateFare(distanceInMeters);
            document.getElementById('estimatedFare').textContent = `₱${fare}`;
        }
        
        // Listen for map clicks to pin user location (The source/pickup)
        map.on('click', function(e) {
            if (window._userPinnedMarker) {
                map.removeLayer(window._userPinnedMarker);
            }
            window._userPinnedLocation = e.latlng;
            window._userPinnedMarker = L.marker(e.latlng, {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32], iconAnchor: [16,32]})}).addTo(map).bindPopup('Your pinned pickup location').openPopup();
            
            // Clear route and reset fare if a location was previously selected
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            window._selectedLocationKey = null; // Clear campus destination
            updateFareDisplay(0);
            showAlert('Pickup location pinned. Now choose a campus destination.');
        });

        // Show route to selected campus (The destination)
        function showRouteToCampus(campusKey) {
            if (!window._userPinnedLocation) {
                showAlert('Please pin your pickup location on the map first.');
                return;
            }
            
            const campus = locations[campusKey];
            if (!campus) return;

            // Remove previous route if any
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            window._selectedLocationKey = campusKey; // Set campus destination

            const startPoint = L.latLng(window._userPinnedLocation.lat, window._userPinnedLocation.lng);
            const endPoint = L.latLng(campus.coords[0], campus.coords[1]);
            
            // Set up the routing control
            routingControl = L.Routing.control({
                waypoints: [
                    startPoint,
                    endPoint
                ],
                routeWhileDragging: false,
                draggableWaypoints: false,
                addWaypoints: false,
                show: false, // Do not show the default route summary
                lineOptions: {
                    styles: [{color: '#1671B7', weight: 6, opacity: 0.85}]
                },
                createMarker: function(i, wp, nWps) {
                    if (i === 0) {
                        // Use the existing pinned marker for the start point, or create one if somehow missing
                        return window._userPinnedMarker || L.marker(wp.latLng, {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32], iconAnchor: [16,32]})}).bindPopup('Your Pinned Location');
                    } else {
                        // Marker for the destination campus
                        return L.marker(wp.latLng).bindPopup(campus.name);
                    }
                }
            }).addTo(map);

            // Calculate and display fare based on route distance
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                if (routes.length > 0) {
                    const distance = routes[0].summary.totalDistance; // distance in meters
                    updateFareDisplay(distance);
                }
            });
            
            showAlert(`Route calculated to ${campus.name}.`);
        }
        
        function getRequestsQueue() {
            const queue = localStorage.getItem('all_requests_queue');
            return queue ? JSON.parse(queue) : [];
        }

        function saveRequestsQueue(queue) {
            localStorage.setItem('all_requests_queue', JSON.stringify(queue));
        }

        function generateUniqueId() {
            // Simple unique ID generation
             return Date.now() + Math.random().toString(36).substring(2, 9);
        }

        function handleMakeRequest() {
            if (!window._userPinnedLocation) {
                showAlert('Please pin your pick-up location on the map first.'); 
                return;
            }
            
            if (!window._selectedLocationKey) {
                showAlert('Please choose a campus destination.'); 
                return;
            }
            
            const fareText = document.getElementById('estimatedFare').textContent;
            
            // 1. Get Request Details
            const loc = locations[window._selectedLocationKey];
            const rideDescription = document.getElementById('rideDescription').value.trim();
            
            const newRequest = {
                id: generateUniqueId(),
                user_lat: window._userPinnedLocation.lat,
                user_lng: window._userPinnedLocation.lng,
                location: loc.name,
                description: rideDescription, 
                fare: fareText, 
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // 2. Add to Queue in Local Storage
            const queue = getRequestsQueue();
            queue.push(newRequest);
            saveRequestsQueue(queue);
            
            // 3. Show the waiting modal
            document.getElementById('waitingModal').style.display = 'flex';
            document.getElementById('waitingMessage').textContent = `Requesting Ride: ${fareText}...`;
            
            // 4. Poll for driver acceptance instead of automatic timeout
            window._currentRequestId = newRequest.id;
            window._requestTimeout = setInterval(() => {
                // Check if the driver accepted the request by looking for 'accepted' status
                const allRequests = getRequestsQueue();
                const acceptedRequest = allRequests.find(req => req.id === window._currentRequestId && req.status === 'accepted');
                
                if (acceptedRequest) {
                    // Driver accepted! Clear the interval and show notification
                    clearInterval(window._requestTimeout);
                    
                    // Update modal message
                    document.getElementById('waitingMessage').textContent = 'Driver accepted your request!';
                    
                    // Close modal after a pause
                    setTimeout(() => {
                        closeWaitingModal();
                        // Show the "Rider is on its way" notification
                        showRiderFoundNotification();
                    }, 1000);
                }
            }, 500); // Check every 500ms for acceptance
        }

        function cancelRequest() {
            // Clear both timeout and interval in case either is running
            clearTimeout(window._requestTimeout);
            clearInterval(window._requestTimeout);
            
            // Remove the request from the queue
            if (window._currentRequestId) {
                const queue = getRequestsQueue();
                const filteredQueue = queue.filter(req => req.id !== window._currentRequestId);
                saveRequestsQueue(filteredQueue);
                window._currentRequestId = null;
            }
            
            closeWaitingModal();
            showAlert('Request cancelled.');
        }

        function closeWaitingModal() {
            document.getElementById('waitingModal').style.display = 'none';
        }
        
        function showRiderFoundNotification() {
            const notification = document.getElementById('riderFoundNotification');
            
            // Use setTimeout to ensure the browser registers the class change for animation
            setTimeout(() => {
                notification.classList.add('visible');
            }, 10);
            
            // Remove the notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('visible');
            }, 5000);
        }

        function showAlert(message) {
            const alertBox = document.getElementById('customAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            
            // Hide alert after 3 seconds
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }
        
        // Initialize fare display
        updateFareDisplay(0);
    </script>
</body>
</html>
