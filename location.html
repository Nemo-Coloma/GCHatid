<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Booking App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Base styles */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
            overflow: hidden; 
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #map {
            flex: 1; 
            height: 100%;
            background-color: #e0e0e0; 
        }

        .sidebar {
            width: 400px; /* Reduced width for a cleaner look */
            background-color: #2c4a69; /* Dark blue background */
            color: white;
            padding: 25px 20px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            text-align: left;
            margin-top: 0;
            font-size: 1.4em; 
            font-weight: 600; 
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* Location Buttons (Destination) */
        .destination-location .location-item {
            text-align: left;
            background-color: rgba(255, 255, 255, 0.08); 
            padding: 15px; 
            margin-bottom: 8px; 
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
        }

        .destination-location .location-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .destination-location .location-item.active {
            background-color: #1f568a; 
            border: 2px solid #15c8ff; 
            box-shadow: 0 0 10px rgba(21, 200, 255, 0.5); 
            font-weight: 600;
        }

        /* Request Button Styling */
        .request-section {
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .make-request-btn {
            width: 100%;
            padding: 18px; 
            background-color: #26c166; 
            background-image: linear-gradient(to top, #26c166, #36d476); 
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px; 
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(38, 193, 102, 0.4); 
        }

        .make-request-btn:hover {
            background-color: #1e9d56;
            background-image: linear-gradient(to top, #1e9d56, #2acb66);
            box-shadow: 0 2px 8px rgba(38, 193, 102, 0.6);
        }
        
        .back-button-container {
            text-align: left;
            margin-bottom: 25px;
        }

        .back-button {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1); 
            border: none;
            color: white;
            font-size: 1.5em;
            padding: 8px 15px; 
            border-radius: 50%;
            cursor: pointer;
            text-decoration: none;
            line-height: 1;
            transition: background-color 0.2s, color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #15c8ff;
        }

        /* --- Custom Location Indicator --- */
        #userLocationDisplay {
            background-color: #15c8ff;
            color: #2c4a69;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }
        
        /* --- Map Click Marker Icon --- */
        .leaflet-div-icon.user-marker-icon {
            background: none;
            border: none;
        }
        .user-marker-icon > div {
            background-color: #15c8ff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* --- Waiting Modal Styles (Copy from pahatid.html) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: rgba(44, 74, 105, 0.95); 
            padding: 40px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            color: white;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #15c8ff; 
            border-radius: 50%;
            width: 50px; 
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content h3 {
             font-size: 1.3em;
             margin-bottom: 10px;
        }

        .cancel-btn-style { 
            padding: 12px 25px;
            background-color: #dc3545; 
            color: white; 
            font-weight: 600;
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            margin-top: 25px;
        }
        /* --- End Waiting Modal Styles --- */

        /* --- Fare Display --- */
        .fare-display {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }
        .fare-display h3 {
            font-size: 1.1em;
            margin: 0;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }
        .fare-display p {
            font-size: 2em;
            font-weight: bold;
            color: #15c8ff;
            margin: 5px 0 0;
        }
        @media (max-width: 768px) {
  /* 1. Stack the map and sidebar vertically */
  .container {
    flex-direction: column; 
    height: 100%; /* Ensure container still uses full height */
  }

  /* 2. Map takes the top half of the screen */
  #map {
    height: 50vh; 
    flex: none; /* Stop flex-grow from fighting with sidebar */
  }

  /* 3. Sidebar takes the bottom half and becomes scrollable */
  .sidebar {
    width: 100%; /* Full screen width */
    height: 50vh; /* Sidebar takes the bottom half of the screen */
    padding: 20px 15px;
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2); /* Shadow on top edge */
    overflow-y: auto; /* Enable vertical scrolling within the sidebar */
    flex: none;
  }

  /* 4. Adjust button size for easier tapping */
  .make-request-btn {
    padding: 16px;
    font-size: 1.1em;
  }
}


    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar">
            <div class="back-button-container">
                <a href="options.html" class="back-button" aria-label="Back to Options">←</a>
            </div>
            
            <div class="section">
                <h3>Your Pick-up Location</h3>
                <div id="userLocationDisplay">Click on the map to set location</div>
            </div>

            <div>
                <div class="section destination-location">
                    <h3>Select Your Destination</h3>
                    <div class="location-item" id="mainCampusBtn" onclick="toggleLocation(this, 'main')">Gordon College Main Campus</div>
                    <div class="location-item" id="annexCampusBtn" onclick="toggleLocation(this, 'annex')">Gordon College ANNEX Campus</div>
                </div>
                
                <div class="section fare-display">
                    <h3>Estimated Fare</h3>
                    <p id="estimatedFare">₱0.00</p>
                </div>
            </div>

            <div class="request-section">
                <button class="make-request-btn" onclick="handleMakeRequest()">Request Ride</button>
            </div>
        </div>
    </div>

    <div id="waitingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="loader"></div>
            <h3>Requesting Ride...</h3>
            <p id="waitingMessage">Waiting for Rider...</p>
            <button onclick="cancelRequest()" class="cancel-btn-style">
                Cancel Request
            </button>
        </div>
    </div>
    
    <div id="customAlert"></div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Leaflet Map Initialization
        var map = L.map('map').setView([14.8314775, 120.2819695], 16); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Global state
        window._userLocation = null; // { lat: X, lng: Y } from map click
        window._userMarker = null;
        window._selectedDestinationKey = null;

        // Coordinates for common locations (must match locations used in all files)
        const destinations = {
            'main': { name: 'Gordon College Main Campus', coords: [14.8324, 120.2833] },
            'annex': { name: 'Gordon College ANNEX Campus', coords: [14.8372648, 120.2798648] }
        };
        
        const MIN_FARE = 50.00;
        const RATE_PER_KM = 15.00; // PHP 15.00 per kilometer after base distance

        // Haversine formula to calculate distance between two lat/lng points in km
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Function to calculate fare (Minimum 50.00 Pesos)
        function calculateFare(pickupLocation, destinationKey) {
            if (!pickupLocation || !destinationKey) return 0;

            const dest = destinations[destinationKey];
            const distance = calculateDistance(pickupLocation.lat, pickupLocation.lng, dest.coords[0], dest.coords[1]);

            // Simplified Fare Calculation: 
            // ₱50.00 Minimum + ₱15.00 per Kilometer
            let fare = MIN_FARE + (distance * RATE_PER_KM);
            
            // Ensure minimum fare is respected
            fare = Math.max(fare, MIN_FARE);
            
            return fare.toFixed(2);
        }
        
        function updateFareDisplay() {
            let fare = '0.00';
            if (window._userLocation && window._selectedDestinationKey) {
                fare = calculateFare(window._userLocation, window._selectedDestinationKey);
            }
            document.getElementById('estimatedFare').textContent = `₱${fare}`;
        }
        
        function toggleLocation(element, key) {
            const items = document.querySelectorAll('.location-item');
            items.forEach(item => item.classList.remove('active')); 
            element.classList.add('active'); 

            window._selectedDestinationKey = key;
            
            // Pan map to destination if a user location is already set
            if (window._userLocation) {
                 map.flyTo(destinations[key].coords, 16, { animate: true, duration: 1.5 });
            }
            
            updateFareDisplay(); // Update fare when destination changes
        }

        // Handle Map Click for User's Location
        map.on('click', function(e) {
            window._userLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
            
            // Custom Icon
            const userIcon = L.divIcon({
                className: 'user-marker-icon',
                html: '<div></div>',
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            });
            
            if (window._userMarker) {
                window._userMarker.setLatLng(e.latlng);
            } else {
                window._userMarker = L.marker(e.latlng, { icon: userIcon }).addTo(map);
            }
            
            document.getElementById('userLocationDisplay').textContent = `Location Set: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            map.setView(e.latlng, 17);
            
            updateFareDisplay(); // Update fare when pickup changes
        });
        
        function getRequestsQueue() {
            const queue = localStorage.getItem('all_requests_queue');
            return queue ? JSON.parse(queue) : [];
        }

        function saveRequestsQueue(queue) {
            localStorage.setItem('all_requests_queue', JSON.stringify(queue));
        }

        function generateUniqueId() {
             return Date.now() + Math.random().toString(36).substring(2, 9);
        }
        
        function handleMakeRequest() {
            if (!window._userLocation) {
                showAlert('Please click on the map to set your current location first.');
                return;
            }

            if (!window._selectedDestinationKey) {
                showAlert('Please select a destination location first.');
                return;
            }
            
            // 1. Get Request Details
            const dest = destinations[window._selectedDestinationKey];
            const fare = calculateFare(window._userLocation, window._selectedDestinationKey);

            const newRequest = {
                id: generateUniqueId(),
                user_lat: window._userLocation.lat,
                user_lng: window._userLocation.lng,
                location: dest.name, // Destination
                fare: fare, // ADDED: Fare is saved here
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // 2. Add to Queue in Local Storage
            const queue = getRequestsQueue();
            queue.push(newRequest);
            saveRequestsQueue(queue);

            // 3. Show the waiting modal (Simulation)
            const waitingModal = document.getElementById('waitingModal');
            waitingModal.style.display = 'flex';
            document.getElementById('waitingMessage').textContent = `Requesting Ride: ₱${fare}...`;

            // 4. Simulate a successful rider match after 3 seconds
            window._requestTimeout = setTimeout(() => {
                // Change modal message before closing
                document.getElementById('waitingMessage').textContent = 'Rider Found! Your request has been queued for a driver.';
                
                // Close modal after a small pause
                setTimeout(() => {
                    closeWaitingModal();
                    // Show the "Rider is on its way" notification (not implemented here but good practice)
                    // showRiderFoundNotification();
                }, 500); 

            }, 3000); 
        }

        function cancelRequest() {
            clearTimeout(window._requestTimeout);
            closeWaitingModal();
            showAlert('Request cancelled.');
        }

        function closeWaitingModal() {
            document.getElementById('waitingModal').style.display = 'none';
        }

        function showAlert(message) {
            const alertBox = document.getElementById('customAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            
            // Hide alert after 3 seconds
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
