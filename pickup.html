<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Request</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Base styles */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
            overflow: hidden; 
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #map {
            flex: 1; 
            height: 100%;
            background-color: #e0e0e0; 
        }

        .sidebar {
            width: 400px; 
            background-color: #2c4a69; /* Dark blue background */
            color: white;
            padding: 25px 20px; /* Increased top/bottom padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2); /* Soft shadow for depth */
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            text-align: left; /* iOS headings often align left */
            margin-top: 0;
            font-size: 1.4em; /* Slightly larger heading */
            font-weight: 600; /* Semi-bold */
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* Location Buttons (Tappable Cells) */
        .pick-up-location .location-item {
            text-align: left;
            background-color: rgba(255, 255, 255, 0.08); /* Lighter background for cells */
            padding: 15px; /* Increased padding */
            margin-bottom: 8px; /* Slightly smaller margin */
            border-radius: 10px; /* Rounded corners */
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
        }

        .pick-up-location .location-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* Active/Clicked State for Location Buttons */
        .pick-up-location .location-item.active {
            background-color: #1f568a; 
            border: 2px solid #15c8ff; /* Light blue accent border */
            box-shadow: 0 0 10px rgba(21, 200, 255, 0.5); /* Glowing effect */
            font-weight: 600;
        }

        /* --- Description Box Styling (NEW) --- */
        .description-box h3 {
             margin-bottom: 15px; 
        }

        #rideDescription {
            width: 100%;
            min-height: 80px; /* Small size */
            max-height: 120px; /* Prevent it from getting too large */
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px; /* Match location items */
            background-color: rgba(255, 255, 255, 0.08); /* Match location items */
            color: white;
            font-size: 1em;
            resize: vertical; /* Allow vertical resize only */
            font-family: inherit; /* Use the iOS font family */
        }

        #rideDescription::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-weight: 300;
        }
        /* --- END Description Box Styling --- */


        /* --- Request Button Styling (Primary Action) --- */
        .request-section {
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .make-request-btn {
            width: 100%;
            padding: 18px; /* Large tap area */
            background-color: #26c166; 
            background-image: linear-gradient(to top, #26c166, #36d476); /* Subtle gradient for depth */
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px; /* iOS-like corner radius */
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(38, 193, 102, 0.4); /* Green shadow */
        }

        .make-request-btn:hover {
            background-color: #1e9d56;
            background-image: linear-gradient(to top, #1e9d56, #2acb66);
            box-shadow: 0 2px 8px rgba(38, 193, 102, 0.6);
        }
        
        /* --- Back Button ICON Styling --- */
        .back-button-container {
            text-align: left;
            margin-bottom: 25px;
        }

        .back-button {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1); /* Subtle background */
            border: none;
            color: white;
            font-size: 1.5em;
            padding: 8px 15px; /* Adjust padding for better look */
            border-radius: 50%;
            cursor: pointer;
            text-decoration: none;
            line-height: 1;
            transition: background-color 0.2s, color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #15c8ff;
        }

        /* --- Waiting Modal Styling (Pop-up Icon) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            /* iOS blurred effect (requires backdrop-filter) */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: rgba(44, 74, 105, 0.95); /* Semi-transparent background */
            padding: 40px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border */
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #15c8ff; /* Accent color */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content h3 {
             font-size: 1.3em;
             margin-bottom: 10px;
        }

        .modal-content p {
            font-size: 1.1em;
            font-weight: 500;
        }

        .cancel-btn-style { /* Class for the button inside the modal */
            padding: 12px 25px;
            background-color: #dc3545; /* Red */
            background-image: linear-gradient(to top, #dc3545, #e05e69);
            color: white; 
            font-weight: 600;
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.4);
            margin-top: 25px;
        }

        .cancel-btn-style:hover {
            background-color: #c82333;
        }
        
        /* --- Rider Found Notification Card --- */
        #riderFoundNotification {
            position: absolute;
            bottom: 20px;
            left: 50%; /* Center in the sidebar */
            transform: translate(-50%, 120px); /* Move off-screen below */
            width: 90%;
            max-width: 360px;
            background-color: #26c166; /* Green */
            background-image: linear-gradient(to right, #26c166, #36d476);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27), opacity 0.5s ease-out; /* Bouncy animation */
            z-index: 999;
        }
        
        #riderFoundNotification.visible {
            transform: translate(-50%, 0); /* Slide up to final position */
            opacity: 1;
        }

        /* --- Custom Alert/Message Box --- */
        #customAlert {
            display: none;
            position: fixed;
            top: 10%; /* Move up slightly */
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #dc3545; /* Use a standard alert red */
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            text-align: center;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        /* --- Fare Display --- */
        .fare-display {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }
        .fare-display h3 {
            font-size: 1.1em;
            margin: 0;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }
        .fare-display p {
            font-size: 2em;
            font-weight: bold;
            color: #15c8ff;
            margin: 5px 0 0;
        }
        @media (max-width: 768px) {
  /* 1. Stack the map and sidebar vertically */
  .container {
    flex-direction: column; 
    height: 100%; /* Ensure container still uses full height */
  }

  /* 2. Map takes the top half of the screen */
  #map {
    height: 50vh; 
    flex: none; /* Stop flex-grow from fighting with sidebar */
  }

  /* 3. Sidebar takes the bottom half and becomes scrollable */
  .sidebar {
    width: 100%; /* Full screen width */
    height: 50vh; /* Sidebar takes the bottom half of the screen */
    padding: 20px 15px;
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2); /* Shadow on top edge */
    overflow-y: auto; /* Enable vertical scrolling within the sidebar */
    flex: none;
  }

  /* 4. Adjust button size for easier tapping */
  .make-request-btn {
    padding: 16px;
    font-size: 1.1em;
  }
}

    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar">
            <div class="back-button-container">
                <a href="options.html" class="back-button" aria-label="Back to Options">←</a>
            </div>
            
            <div>
                <div class="section pick-up-location">
                    <h3>Pick-up Location</h3>
                    <div class="location-item" id="mainCampusBtn" onclick="toggleLocation(this, 'main')">Gordon College Main Campus</div>
                    <div class="location-item" id="annexCampusBtn" onclick="toggleLocation(this, 'annex')">Gordon College ANNEX Campus</div>
                </div>

                <div class="section description-box">
                    <h3>Description (Optional)</h3>
                    <textarea id="rideDescription" placeholder="e.g., I have a black bag and long hair" rows="3"></textarea>
                </div>
                
                <div class="section fare-display">
                    <h3>Estimated Fare</h3>
                    <p id="estimatedFare">₱0.00</p>
                </div>

            </div>

            <div class="request-section">
                
                <button class="make-request-btn" onclick="handleMakeRequest()">Make Request</button>
            </div>
        </div>
    </div>

    <div id="waitingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="loader"></div>
            <h3>Requesting Ride...</h3>
            <p id="waitingMessage">Waiting for Rider...</p>
            <button onclick="cancelRequest()" class="cancel-btn-style">
                Cancel Request
            </button>
        </div>
    </div>
    
    <div id="customAlert"></div>

    <div id="riderFoundNotification">
        <p style="font-size: 1.1em; margin: 0; font-weight: bold;">Rider is on its way!</p>
        <p style="font-size: 0.9em; margin: 5px 0 0;">Check your status on the map.</p>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Leaflet Map Initialization (kept simple)
        var map = L.map('map').setView([14.8314775, 120.2819695], 16); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

       

        // Coordinates for common locations (must match locations used in all files)
        const locations = {
            'main': { name: 'Gordon College Main Campus', coords: [14.8324, 120.2833] },
            'annex': { name: 'Gordon College ANNEX Campus', coords: [14.8372648, 120.2798648] }
        };
        
        // Global state for request timeout and selected location
        window._requestTimeout = null;
        window._pickupMarker = null;
        window._selectedLocationKey = 'main'; // Default to main

        // Function to calculate fare (Minimum 50.00 Pesos)
        function calculateFare(locationKey) {
            // Placeholder: Since we only have two fixed locations, we'll use a simple fixed rate.
            // In a real app, you would use a distance/time matrix API.
            
            const BASE_FARE = 50.00;
            let distance_rate = 0;

            if (locationKey === 'main') {
                distance_rate = 0; // Assuming a minimal trip distance from main
            } else if (locationKey === 'annex') {
                // If the user selects the Annex, charge a slightly higher flat rate 
                // to simulate a slightly longer travel distance/time.
                distance_rate = 5; 
            }
            
            const fare = BASE_FARE + distance_rate;
            return fare.toFixed(2);
        }
        
        function updateFareDisplay() {
            const fare = calculateFare(window._selectedLocationKey);
            document.getElementById('estimatedFare').textContent = `₱${fare}`;
        }
        
        function toggleLocation(element, key) {
            const items = document.querySelectorAll('.location-item');
            items.forEach(item => item.classList.remove('active')); 
            element.classList.add('active'); 

            window._selectedLocationKey = key;
            const loc = locations[key];
            
            if (loc) {
                map.flyTo(loc.coords, 18, { animate: true, duration: 1.5 }); 
                if (window._pickupMarker) {
                    window._pickupMarker.setLatLng(loc.coords).setPopupContent(loc.name).openPopup();
                } else {
                    window._pickupMarker = L.marker(loc.coords).addTo(map).bindPopup(loc.name).openPopup();
                }
            }
            updateFareDisplay(); // Update fare when location changes
        }
        
        function getRequestsQueue() {
            const queue = localStorage.getItem('all_requests_queue');
            return queue ? JSON.parse(queue) : [];
        }

        function saveRequestsQueue(queue) {
            localStorage.setItem('all_requests_queue', JSON.stringify(queue));
        }

        function generateUniqueId() {
            // Simple unique ID generation
             return Date.now() + Math.random().toString(36).substring(2, 9);
        }

        function handleMakeRequest() {
            if (!window._selectedLocationKey) {
                showAlert('Please select a pick-up location first.'); 
                return;
            }

            // 1. Get Request Details
            const loc = locations[window._selectedLocationKey];
            const fare = calculateFare(window._selectedLocationKey);
            const rideDescription = document.getElementById('rideDescription').value.trim();
            
            const newRequest = {
                id: generateUniqueId(),
                location: loc.name,
                description: rideDescription, 
                fare: fare, // ADDED: Fare is saved here
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // 2. Add to Queue in Local Storage
            const queue = getRequestsQueue();
            queue.push(newRequest);
            saveRequestsQueue(queue);
            
            // 3. Show the waiting modal (Simulation)
            document.getElementById('waitingModal').style.display = 'flex';
            document.getElementById('waitingMessage').textContent = `Requesting Ride: ₱${fare}...`;
            
            // 4. Simulate a successful rider match after 3 seconds
            window._requestTimeout = setTimeout(() => {
                // Change modal message before closing
                document.getElementById('waitingMessage').textContent = 'Rider Found! Your request has been queued for a driver.';
                
                // Close modal after a small pause
                setTimeout(() => {
                    closeWaitingModal();
                    // Show the "Rider is on its way" notification
                    showRiderFoundNotification();
                }, 500); 

            }, 3000); // 3 seconds simulation time
        }

        function cancelRequest() {
            clearTimeout(window._requestTimeout);
            closeWaitingModal();
            // In a real app, you'd need to send a cancel request to the server.
            showAlert('Request cancelled.');
        }

        function closeWaitingModal() {
            document.getElementById('waitingModal').style.display = 'none';
        }
        
        function showRiderFoundNotification() {
            const notification = document.getElementById('riderFoundNotification');
            
            // Use setTimeout to ensure the browser registers the class change for animation
            setTimeout(() => {
                notification.classList.add('visible');
            }, 10);
            
            // Remove the notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('visible');
            }, 5000);
        }

        function showAlert(message) {
            const alertBox = document.getElementById('customAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            
            // Hide alert after 3 seconds
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        // Campus routing logic
        function showCampusRoute(fromKey) {
    // fromKey: 'main' or 'annex'
    // Route should go to the other campus
    var toKey = fromKey === 'main' ? 'annex' : 'main';
    var fromLoc = locations[fromKey].coords;
    var toLoc = locations[toKey].coords;
    if (window._campusRouteControl) {
        map.removeControl(window._campusRouteControl);
    }
    window._campusRouteControl = L.Routing.control({
        waypoints: [L.latLng(fromLoc[0], fromLoc[1]), L.latLng(toLoc[0], toLoc[1])],
        routeWhileDragging: false,
        draggableWaypoints: false,
        addWaypoints: false,
        show: false,
        lineOptions: {
            styles: [{color: '#1671B7', weight: 6, opacity: 0.85}]
        },
        createMarker: function(i, wp, nWps) {
            if (i === 0) {
                return L.marker(wp.latLng).bindPopup(locations[fromKey].name);
            } else {
                return L.marker(wp.latLng).bindPopup(locations[toKey].name);
            }
        }
    }).addTo(map);
}

// Attach to campus buttons
const mainBtn = document.getElementById('mainCampusBtn');
const annexBtn = document.getElementById('annexCampusBtn');
if (mainBtn && annexBtn) {
    mainBtn.onclick = function() {
        toggleLocation(this, 'main');
        showCampusRoute('main');
    };
    annexBtn.onclick = function() {
        toggleLocation(this, 'annex');
        showCampusRoute('annex');
    };
}

// Initialize by selecting the first location and setting fare
        document.getElementById('mainCampusBtn').click();
        updateFareDisplay();
    </script>
</body>
</html>
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
