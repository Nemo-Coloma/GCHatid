<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Request</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Base styles (Copied from pahatid.html) */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
            overflow: hidden; 
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #map {
            flex: 1; 
            height: 100%;
            background-color: #e0e0e0; 
        }

        .sidebar {
            width: 400px; 
            background-color: #0f2336; /* Dark blue background (PAHATID Theme) */
            color: white;
            padding: 25px 20px; /* Increased top/bottom padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2); 
        }
        
        /* This wrapper makes the content inside scrollable and pushes the request-section down (Original pickup.html structure) */
        .main-content-area {
            flex-grow: 1;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            text-align: left; 
            margin-top: 0;
            font-size: 1.4em; 
            font-weight: 600; 
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* Location Buttons (Tappable Cells) - Styling from pahatid.html's aesthetic */
        .pick-up-location .location-item {
            text-align: left;
            background-color: rgba(255, 255, 255, 0.08); /* Lighter background for cells */
            padding: 15px; 
            margin-bottom: 8px; 
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
        }

        .pick-up-location .location-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* Active/Clicked State for Location Buttons - Styling from pahatid.html's aesthetic */
        .pick-up-location .location-item.active {
            background-color: #1f568a; 
            border: 2px solid #15c8ff; 
            box-shadow: 0 0 10px rgba(21, 200, 255, 0.5); 
            font-weight: 600;
        }

        /* --- Description Box Styling (Copied from pahatid.html) --- */
        .description-box h3 {
             margin-bottom: 15px; 
        }

        #rideDescription {
            width: 100%;
            min-height: 80px; 
            max-height: 120px; 
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px; 
            background-color: rgba(255, 255, 255, 0.08); 
            color: white;
            font-size: 1em;
            resize: vertical; 
            font-family: inherit; 
        }

        #rideDescription::placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-weight: 300;
        }

        /* --- Request Button Styling (Primary Action) (Copied from pahatid.html) --- */
        .request-section {
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0; 
        }
        
        .make-request-btn {
            width: 100%;
            padding: 18px; 
            background-color: #26c166; 
            background-image: linear-gradient(to top, #26c166, #36d476); 
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px; 
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(38, 193, 102, 0.4); 
        }

        .make-request-btn:hover {
            background-color: #1e9d56;
            background-image: linear-gradient(to top, #1e9d56, #2acb66);
            box-shadow: 0 2px 8px rgba(38, 193, 102, 0.6);
        }
        
        /* --- Back Button ICON Styling (Copied from pahatid.html) --- */
        .back-button-container {
            text-align: left;
            margin-bottom: 25px;
        }

        .back-button {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1); 
            border: none;
            color: white;
            font-size: 1.2em; 
            padding: 6px 12px; 
            border-radius: 50%;
            cursor: pointer;
            text-decoration: none;
            line-height: 1;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #15c8ff;
        }

        /* --- Modal and Notification Styles (Copied from pahatid.html) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: rgba(44, 74, 105, 0.95); 
            padding: 40px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #15c8ff; 
            border-radius: 50%;
            width: 50px; 
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-content h3 {
             font-size: 1.3em;
             margin-bottom: 10px;
        }

        .modal-content p {
            font-size: 1.1em;
            font-weight: 500;
        }

        .cancel-btn-style { 
            padding: 12px 25px;
            background-color: #dc3545; 
            background-image: linear-gradient(to top, #dc3545, #e05e69);
            color: white; 
            font-weight: 600;
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.4);
            margin-top: 25px;
        }

        .cancel-btn-style:hover {
            background-color: #c82333;
        }
        
        #riderFoundNotification {
            position: absolute;
            bottom: 20px;
            left: 50%; 
            transform: translate(-50%, 120px); 
            width: 90%;
            max-width: 360px;
            background-color: #26c166; 
            background-image: linear-gradient(to right, #26c166, #36d476);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27), opacity 0.5s ease-out; 
            z-index: 999;
        }
        
        #riderFoundNotification.visible {
            transform: translate(-50%, 0); 
            opacity: 1;
        }

        #customAlert {
            display: none;
            position: fixed;
            top: 10%; 
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #dc3545; 
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            text-align: center;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        /* --- Fare Display (Copied from pahatid.html) --- */
        .fare-display {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }
        .fare-display h3 {
            font-size: 1.1em;
            margin: 0;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }
        .fare-display p {
            font-size: 2em;
            font-weight: bold;
            color: #15c8ff;
            margin: 5px 0 0;
        }

        /* Mobile Responsiveness Adjustments (CRITICAL FIXES - Copied from pahatid.html) */
        @media (max-width: 768px) {
            /* FIX: Ensure body allows 100% viewport and prevents scrolling */
            body {
                overflow-y: hidden; 
                height: 100vh;
            }
            .container {
                flex-direction: column; 
                height: 100%; 
            }

            /* 1. Map takes 40% of the screen */
            #map {
                height: 40vh; 
                flex: none; 
            }

            /* 2. Sidebar takes the remaining 60% and is NOT scrollable */
            .sidebar {
                width: 100%; 
                height: 60vh; 
                padding: 15px; 
                box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2); 
                overflow-y: hidden; /* Ensure sidebar itself doesn't scroll */
                flex: none;
                justify-content: flex-start; /* CRITICAL: Pushes main content up */
            }

            /* 3. Significantly reduce vertical spacing and compact elements */
            
            .back-button-container {
                 margin-bottom: 8px; /* Reduced from 25px */
            }

            /* CRITICAL FIX: Make content area scrollable and push button to bottom */
            .main-content-area {
                flex-grow: 1; /* Take all available space, pushing request-section down */
                overflow-y: auto; /* Allow scrolling within this area */
                padding-bottom: 8px; 
            }
            
            .section {
                margin-bottom: 8px; /* Reduced from 25px */
            }

            .section h3 {
                padding-bottom: 5px; 
                margin-bottom: 5px; 
                font-size: 1.2em; 
            }

            .pick-up-location .location-item {
                padding: 12px; /* Reduced padding */
                margin-bottom: 5px; /* Reduced margin */
                font-size: 0.9em; /* Reduced font size */
            }
            
            #rideDescription {
                min-height: 40px; 
                max-height: 60px; 
                padding: 8px; 
            }
            
            .fare-display {
                margin-top: 5px; 
                padding: 8px; /* Reduced padding */
            }
            
            .fare-display p {
                font-size: 1.8em; 
            }

            /* **CRITICAL: Bring Make Request button closer** */
            .request-section {
                padding-top: 5px; /* Reduced from 25px to 5px */
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .make-request-btn {
                padding: 12px; 
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar">
            <div class="back-button-container">
                <a href="options.html" class="back-button" aria-label="Back to Options">←</a>
            </div>
            
            <div class="main-content-area">
                <div class="section pick-up-location">
                    <h3>Pick-up Location</h3>
                    <div class="location-item" id="mainCampusBtn" onclick="toggleLocation(this, 'main')">Gordon College Main Campus</div>
                    <div class="location-item" id="annexCampusBtn" onclick="toggleLocation(this, 'annex')">Gordon College ANNEX Campus</div>
                </div>

                <div class="section description-box">
                    <h3>Description (Optional)</h3>
                    <textarea id="rideDescription" placeholder="e.g., I have a black bag and long hair" rows="3"></textarea>
                </div>
                
                <div class="section fare-display">
                    <h3>Estimated Fare</h3>
                    <p id="estimatedFare">₱0.00</p>
                </div>

            </div>
            <div class="request-section">
                
                <button class="make-request-btn" onclick="handleMakeRequest()">Make Request</button>
            </div>
        </div>
    </div>

    <div id="waitingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="loader"></div>
            <h3>Requesting Ride...</h3>
            <p id="waitingMessage">Waiting for Rider...</p>
            <button onclick="cancelRequest()" class="cancel-btn-style">
                Cancel Request
            </button>
        </div>
    </div>
    
    <div id="customAlert"></div>

    <div id="riderFoundNotification">
        <p style="font-size: 1.1em; margin: 0; font-weight: bold;">Rider is on its way!</p>
        <p style="font-size: 0.9em; margin: 5px 0 0;">Check your status on the map.</p>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Leaflet Map Initialization (kept simple)
        var map = L.map('map').setView([14.8327253, 120.2796366], 17); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

       

        // Coordinates for common locations (must match locations used in all files)
        const locations = {
            'main': { name: 'Gordon College Main Campus', coords: [14.8327253, 120.2796366] },
            'annex': { name: 'Gordon College ANNEX Campus', coords: [14.8373148, 120.2771703] }
        };
        
        // Global state for request timeout and selected location
        window._requestTimeout = null;
        window._pickupMarker = null;
        window._selectedLocationKey = 'main'; // Default to main

        // Function to calculate fare (Minimum 50.00 Pesos)
        function calculateFare(locationKey) {
            // Placeholder: Since we only have two fixed locations, we'll use a simple fixed rate.
            // In a real app, you would use a distance/time matrix API.
            
            const BASE_FARE = 50.00;
            let distance_rate = 0;

            if (locationKey === 'main') {
                distance_rate = 0; // Assuming a minimal trip distance from main
            } else if (locationKey === 'annex') {
                // If the user selects the Annex, charge a slightly higher flat rate 
                // to simulate a slightly longer travel distance/time.
                distance_rate = 5; 
            }
            
            const fare = BASE_FARE + distance_rate;
            return fare.toFixed(2);
        }
        
        function updateFareDisplay() {
            const fare = calculateFare(window._selectedLocationKey);
            document.getElementById('estimatedFare').textContent = `₱${fare}`;
        }
        
        function toggleLocation(element, key) {
            const items = document.querySelectorAll('.location-item');
            items.forEach(item => item.classList.remove('active')); 
            element.classList.add('active'); 

            window._selectedLocationKey = key;
            const loc = locations[key];
            
            if (loc) {
                map.flyTo(loc.coords, 18, { animate: true, duration: 1.5 }); 
                if (window._pickupMarker) {
                    window._pickupMarker.setLatLng(loc.coords).setPopupContent(loc.name).openPopup();
                } else {
                    window._pickupMarker = L.marker(loc.coords).addTo(map).bindPopup(loc.name).openPopup();
                }
            }
            updateFareDisplay(); // Update fare when location changes
        }
        
        function getRequestsQueue() {
            const queue = localStorage.getItem('all_requests_queue');
            return queue ? JSON.parse(queue) : [];
        }

        function saveRequestsQueue(queue) {
            localStorage.setItem('all_requests_queue', JSON.stringify(queue));
        }

        function generateUniqueId() {
            // Simple unique ID generation
             return Date.now() + Math.random().toString(36).substring(2, 9);
        }

        function handleMakeRequest() {
            if (!window._selectedLocationKey) {
                showAlert('Please select a pick-up location first.'); 
                return;
            }

            // 1. Get Request Details
            const loc = locations[window._selectedLocationKey];
            const fare = calculateFare(window._selectedLocationKey);
            const rideDescription = document.getElementById('rideDescription').value.trim();
            
            const newRequest = {
                id: generateUniqueId(),
                user_lat: loc.coords[0], // Store latitude
                user_lng: loc.coords[1], // Store longitude
                location: loc.name,
                description: rideDescription, 
                fare: fare,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // 2. Add to Queue in Local Storage
            const queue = getRequestsQueue();
            queue.push(newRequest);
            saveRequestsQueue(queue);
            
            // 3. Show the waiting modal
            document.getElementById('waitingModal').style.display = 'flex';
            document.getElementById('waitingMessage').textContent = `Requesting Ride: ₱${fare}...`;

            // 4. Poll for driver acceptance instead of automatic timeout
            window._currentRequestId = newRequest.id;
            window._requestTimeout = setInterval(() => {
                // Check if the driver accepted the request by looking for 'accepted' status
                const allRequests = getRequestsQueue();
                const acceptedRequest = allRequests.find(req => req.id === window._currentRequestId && req.status === 'accepted');

                if (acceptedRequest) {
                    // Driver accepted! Clear the interval and show notification
                    clearInterval(window._requestTimeout);

                    // Update modal message
                    document.getElementById('waitingMessage').textContent = 'Driver accepted your request!';

                    // Close modal after a pause
                    setTimeout(() => {
                        closeWaitingModal();
                        // Show the "Rider is on its way" notification
                        showRiderFoundNotification();
                    }, 1000);
                }
            }, 500); // Check every 500ms for acceptance
        }

        function cancelRequest() {
            clearTimeout(window._requestTimeout);
            // Re-use interval check on cancel
            clearInterval(window._requestTimeout); 
            
            // Remove the request from the queue (Added this logic from pahatid.html for consistency in queue management)
            if (window._currentRequestId) {
                const queue = getRequestsQueue();
                const filteredQueue = queue.filter(req => req.id !== window._currentRequestId);
                saveRequestsQueue(filteredQueue);
                window._currentRequestId = null;
            }
            
            closeWaitingModal();
            showAlert('Request cancelled.');
        }

        function closeWaitingModal() {
            document.getElementById('waitingModal').style.display = 'none';
        }
        
        function showRiderFoundNotification() {
            const notification = document.getElementById('riderFoundNotification');
            
            // Use setTimeout to ensure the browser registers the class change for animation
            setTimeout(() => {
                notification.classList.add('visible');
            }, 10);
            
            // Remove the notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('visible');
            }, 5000);
        }

        function showAlert(message) {
            const alertBox = document.getElementById('customAlert');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            
            // Hide alert after 3 seconds
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        // Initialize by selecting the first location and setting fare
        document.getElementById('mainCampusBtn').click();
        updateFareDisplay();
    </script>
</body>
</html>
